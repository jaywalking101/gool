/* Copyright (C) 2013 Justin Windle, http://soulwire.co.uk */
define(function(){"use strict";function l(a){return"[object Array]"==Object.prototype.toString.call(a)}function m(a){return"function"==typeof a}function n(a){return"number"==typeof a}function o(a){return"string"==typeof a}function p(a){return k[a]||String.fromCharCode(a)}function q(a,b,c){for(var d in b)!c&&d in a||(a[d]=b[d]);return a}function r(a,b){return function(){a.apply(b,arguments)}}function s(a){var b={};for(var c in a)b[c]=m(a[c])?r(a[c],a):a[c];return b}function t(a){function O(b){m(b)&&b.apply(a,[].splice.call(arguments,1))}function P(a){for(n=0;n<M.length;n++)u=M[n],o(u)?e[(a?"add":"remove")+"EventListener"].call(e,u,c,!1):m(u)?c=u:e=u}function Q(){E(b),b=D(Q),H||(O(a.setup),H=m(a.setup),O(a.resize)),a.running&&!F&&(a.dt=(t=+new Date)-a.now,a.millis+=a.dt,a.now=t,O(a.update),a.autoclear&&K&&a.clear(),O(a.draw)),F=++F%a.interval}function R(){e=J?a.style:a.canvas,r=J?"px":"",B=a.width,C=a.height,a.fullscreen&&(C=a.height=h.innerHeight,B=a.width=h.innerWidth),a.retina&&K&&I&&(e.style.height=C+"px",e.style.width=B+"px",B*=I,C*=I,a.scale(I,I)),e.height!==C&&(e.height=C+r),e.width!==B&&(e.width=B+r),H&&O(a.resize)}function S(a,b){return l=b.getBoundingClientRect(),a.x=a.pageX-l.left-h.scrollX,a.y=a.pageY-l.top-h.scrollY,a}function T(b,c){return S(b,a.element),c=c||{},c.ox=c.x||b.x,c.oy=c.y||b.y,c.x=b.x,c.y=b.y,c.dx=c.x-c.ox,c.dy=c.y-c.oy,c}function U(a){if(a.preventDefault(),v=s(a),v.originalEvent=a,v.touches)for(G.length=v.touches.length,n=0;n<v.touches.length;n++)G[n]=T(v.touches[n],G[n]);else G.length=0,G[0]=T(v,L);return q(L,G[0],!0),v}function V(b){for(b=U(b),z=(A=M.indexOf(w=b.type))-1,a.dragging=/down|start/.test(w)?!0:/up|end/.test(w)?!1:a.dragging;z;)o(M[z])?O(a[M[z--]],b):o(M[A])?O(a[M[A++]],b):z=0}function W(b){x=b.keyCode,y="keyup"==b.type,N[x]=N[p(x)]=!y,O(a[b.type],b)}function X(b){a.autopause&&("blur"==b.type?Z:Y)(),O(a[b.type],b)}function Y(){a.now=+new Date,a.running=!0}function Z(){a.running=!1}function $(){(a.running?Z:Y)()}function _(){K&&a.clearRect(0,0,a.width,a.height)}function ab(){j=a.element.parentNode,n=i.indexOf(a),j&&j.removeChild(a.element),~n&&i.splice(n,1),P(!1),Z()}var b,c,e,j,l,n,r,t,u,v,w,x,y,z,A,B,C,F=0,G=[],H=!1,I=h.devicePixelRatio,J=a.type==f,K=a.type==d,L={x:0,y:0,ox:0,oy:0,dx:0,dy:0},M=[a.element,V,"mousedown","touchstart",V,"mousemove","touchmove",V,"mouseup","touchend",V,"click",g,W,"keydown","keyup",h,X,"focus","blur",R,"resize"],N={};for(x in k)N[k[x]]=!1;return q(a,{touches:G,mouse:L,keys:N,dragging:!1,running:!1,millis:0,now:0/0,dt:0/0,destroy:ab,toggle:$,clear:_,start:Y,stop:Z}),i.push(a),a.autostart&&Y(),P(!0),R(),Q(),a}var g,h,a="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),b="__hasSketch",c=Math,d="canvas",e="webgl",f="dom";"undefined"!=typeof document&&"undefined"!=typeof window?(g=document,h=window):(g={body:null},h={cancelAnimationFrame:null,requestAnimationFrame:null});for(var u,v,i=[],j={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:g.body,interval:1,globals:!0,retina:!1,type:d},k={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},w={CANVAS:d,WEB_GL:e,WEBGL:e,DOM:f,instances:i,install:function(d){if(!d[b]){for(var e=0;e<a.length;e++)d[a[e]]=c[a[e]];q(d,{TWO_PI:2*c.PI,HALF_PI:c.PI/2,QUATER_PI:c.PI/4,random:function(a,b){return l(a)?a[~~(c.random()*a.length)]:(n(b)||(b=a||1,a=0),a+c.random()*(b-a))},lerp:function(a,b,c){return a+c*(b-a)},map:function(a,b,c,d,e){return(a-b)/(c-b)*(e-d)+d}}),d[b]=!0}},create:function(a){return a=q(a||{},j),a.globals&&w.install(h),u=a.element=a.element||g.createElement(a.type===f?"div":"canvas"),v=a.context=a.context||function(){switch(a.type){case d:return u.getContext("2d",a);case e:return u.getContext("webgl",a)||u.getContext("experimental-webgl",a);case f:return u.canvas=u}}(),(a.container||g.body).appendChild(u),w.augment(v,a)},augment:function(a,b){return b=q(b||{},j),b.element=a.canvas||a,b.element.className+=" sketch",q(a,b,!0),t(a)}},x=["ms","moz","webkit","o"],y=h,z=0,A="AnimationFrame",B="request"+A,C="cancel"+A,D=y[B],E=y[C],F=0;F<x.length&&!D;F++)D=y[x[F]+"Request"+A],E=y[x[F]+"Cancel"+A];return y[B]=D=D||function(a){var b=+new Date,d=c.max(0,16-(b-z)),e=setTimeout(function(){a(b+d)},d);return z=b+d,e},y[C]=E=E||function(a){clearTimeout(a)},w});
